<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SVG to PNG</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 20px;
        }

        section {
            display: inline-block;
            width: 350px;
            vertical-align: top;
        }

        #dpi {
            position: absolute;
            top: -100%;
            left: -100%;
            width: 1in;
            height: 1in;
        }

        @media print {
            @page {
                size: A4 portrait;
                margin: 0;
            }

            body {
                margin: 0;
            }

            #dpi {
                /* workaround to printing in Chrome not obeying the @page size  */
                left: 0;
            }
        }
    </style>
</head>
<body>

<h1>SVG to PNG</h1>

<div id="dpi"></div>

<div>
    <label><input id="color" type="checkbox"> Global CSS</label>
    <script>
      (() => {
        const checkbox = document.getElementById("color");
        const body = document.querySelector("body");
        checkbox.addEventListener("change", () => {
          body.style.color = checkbox.checked ? "red" : null;
        });
      })();

      async function saveAsPng(element) {
        console.log(element);

        let imageElement;
        if (element instanceof HTMLImageElement) {
          imageElement = element;
        } else if (element instanceof SVGSVGElement) {
          imageElement = await svgToImage(element);
        } else if (element instanceof HTMLObjectElement) {
          imageElement = await svgToImage(element.contentDocument.documentElement);
        } else {
          throw Error("Unsupported element " + element.constructor.name)
        }

        const canvas = renderToCanvas(imageElement);
        const dataUrl = canvas.toDataURL('image/png');
        triggerDownload(dataUrl, "image.png")
      }

      function svgToImage(svgElement) {
        const svg = new XMLSerializer().serializeToString(svgElement);
        return new Promise((resolve, reject) => {
          const image = new Image();
          image.onload = () => {
            resolve(image);
          };
          image.onerror = () => {
            reject(new Error("svgToImage failed"));
          }
          image.src = 'data:image/svg+xml;base64,' + btoa(svg);
        });
      }

      function renderToCanvas(imageElement, dpi = 300) {
        const connected = imageElement.isConnected;
        if (!connected) {
          // the image must be in the DOM, or its width and height will be zero
          document.body.appendChild(imageElement);
        }
        const imageWidth = imageElement.clientWidth;
        const imageHeight = imageElement.clientHeight;
        if (!connected) {
          document.body.removeChild(imageElement);
        }

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // calculate the dimensions for the canvas to achieve target DPI
        const scaleFactor = dpi / screenDpi();
        canvas.width = imageWidth * scaleFactor;
        canvas.height = imageHeight * scaleFactor;
        canvas.style.width = `${imageWidth}px`;
        canvas.style.height = `${imageHeight}px`;

        // scale the original image to the canvas DPI
        ctx.scale(scaleFactor, scaleFactor);

        ctx.drawImage(imageElement, 0, 0);
        return canvas;
      }

      function screenDpi() {
        return document.getElementById("dpi").offsetHeight; // typically 96
      }

      function triggerDownload(dataUrl, filename) {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = filename;
        link.click();
      }
    </script>
</div>

<section>
    <h2>&lt;svg&gt;</h2>
    <svg id="inline" xmlns="http://www.w3.org/2000/svg"
         viewBox="0 0 300 300" x="0" y="0" height="300" width="300">
        <circle r="142" cx="150" cy="150" fill="none" stroke="#000000" stroke-width="2"/>
        <foreignObject x="50" y="50" width="200" height="200">
            <div xmlns="http://www.w3.org/1999/xhtml"
                 style="
                    width: 196px;
                    height: 196px;
                    border: solid 2px #000000;
                    font-size: 16px;
                    overflow: hidden;
                    /* reset global CSS */
                    line-height: 18px;
                    box-sizing: unset;">
                <style>
                    p {
                        margin: 0;
                        padding: 0;
                    }
                </style>
                <p>this is html in svg 1</p>
                <p>this is html in svg 2</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut pretium libero ipsum, a sodales quam
                    vulputate eget. Donec id lorem at eros maximus semper. Quisque quis congue purus. Suspendisse est
                    nisl, congue sed sapien eget, vehicula scelerisque sapien. Mauris nec ipsum sed lacus hendrerit
                    auctor. Morbi viverra mollis justo, sit amet congue nibh malesuada at. Vivamus et nisi vel magna
                    molestie vestibulum sollicitudin ac nulla. Quisque eget mi elementum ante elementum interdum ac non
                    sem. Maecenas sed erat eget ex imperdiet mattis vitae at ligula. Integer quam tortor, laoreet vel
                    tincidunt ac, imperdiet ac erat. Sed sagittis augue facilisis bibendum dapibus. Integer ut ornare
                    dolor.
                </p>
            </div>
        </foreignObject>
    </svg>
    <p>
        <button id="inline-save">Save as PNG</button>
    </p>
    <p><label><input id="inline-slider" type="range" min="0" max="100"> SVG DOM</label></p>
    <script>
      (() => {
        const image = document.getElementById("inline");
        const button = document.getElementById("inline-save");
        const slider = document.getElementById("inline-slider");

        button.addEventListener("click", () => {
          saveAsPng(image);
        });

        const square = image.querySelector("div");
        slider.value = slider.max = parseInt(square.style.height, 10);
        slider.addEventListener("input", () => {
          square.style.height = `${slider.value}px`
        });
      })();
    </script>
</section>

<section>
    <h2>&lt;object data="image.svg"&gt;</h2>
    <object id="object-url" data="image.svg" type="image/svg+xml"></object>
    <p>
        <button id="object-url-save">Save as PNG</button>
    </p>
    <p><label><input id="object-url-slider" type="range" min="0" max="100"> SVG DOM</label></p>
    <p>⚠️ Firefox prints this at half the size. Other images are OK.</p>
    <script>
      (() => {
        const image = document.getElementById("object-url");
        const button = document.getElementById("object-url-save");
        const slider = document.getElementById("object-url-slider");

        button.addEventListener("click", () => {
          saveAsPng(image);
        });

        image.addEventListener("load", () => {
          const square = image.contentDocument.querySelector("div");
          slider.value = slider.max = parseInt(square.style.height, 10);
          slider.addEventListener("input", () => {
            square.style.height = `${slider.value}px`
          });
        });
      })();
    </script>
</section>

<section>
    <h2>&lt;img src="image.svg"&gt;</h2>
    <img id="img-url" alt="" src="image.svg"/>
    <p>
        <button id="img-url-save">Save as PNG</button>
    </p>
    <p>⚠️ Chrome fails to save this as PNG ("Tainted canvases may not be exported"). Firefox can do it.</p>
    <script>
      (() => {
        const image = document.getElementById("img-url");
        const button = document.getElementById("img-url-save");

        button.addEventListener("click", () => {
          saveAsPng(image);
        });
      })();
    </script>
</section>

<section>
    <h2>&lt;img src="data:image/svg+xml"&gt;</h2>
    <img id="img-data" alt=""
         src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICAgdmlld0JveD0iMCAwIDMwMCAzMDAiIHg9IjAiIHk9IjAiIGhlaWdodD0iMzAwIiB3aWR0aD0iMzAwIj4KICA8Y2lyY2xlIHI9IjE0MiIgY3g9IjE1MCIgY3k9IjE1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMDAwIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8Zm9yZWlnbk9iamVjdCB4PSI1MCIgeT0iNTAiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj4KICAgIDxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiCiAgICAgICAgIHN0eWxlPSIKICAgICAgICAgICAgd2lkdGg6IDE5NnB4OwogICAgICAgICAgICBoZWlnaHQ6IDE5NnB4OwogICAgICAgICAgICBib3JkZXI6IHNvbGlkIDJweCAjMDAwMDAwOwogICAgICAgICAgICBmb250LXNpemU6IDE2cHg7CiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgIC8qIHJlc2V0IGdsb2JhbCBDU1MgKi8KICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDE4cHg7CiAgICAgICAgICAgIGJveC1zaXppbmc6IHVuc2V0OyI+CiAgICAgIDxzdHlsZT4KICAgICAgICBwIHsKICAgICAgICBtYXJnaW46IDA7CiAgICAgICAgcGFkZGluZzogMDsKICAgICAgICB9CiAgICAgIDwvc3R5bGU+CiAgICAgIDxwPnRoaXMgaXMgaHRtbCBpbiBzdmcgMTwvcD4KICAgICAgPHA+dGhpcyBpcyBodG1sIGluIHN2ZyAyPC9wPgogICAgICA8cD5Mb3JlbSBpcHN1bSBkb2xvciBzaXQgYW1ldCwgY29uc2VjdGV0dXIgYWRpcGlzY2luZyBlbGl0LiBVdCBwcmV0aXVtIGxpYmVybyBpcHN1bSwgYSBzb2RhbGVzIHF1YW0KICAgICAgICB2dWxwdXRhdGUgZWdldC4gRG9uZWMgaWQgbG9yZW0gYXQgZXJvcyBtYXhpbXVzIHNlbXBlci4gUXVpc3F1ZSBxdWlzIGNvbmd1ZSBwdXJ1cy4gU3VzcGVuZGlzc2UgZXN0CiAgICAgICAgbmlzbCwgY29uZ3VlIHNlZCBzYXBpZW4gZWdldCwgdmVoaWN1bGEgc2NlbGVyaXNxdWUgc2FwaWVuLiBNYXVyaXMgbmVjIGlwc3VtIHNlZCBsYWN1cyBoZW5kcmVyaXQKICAgICAgICBhdWN0b3IuIE1vcmJpIHZpdmVycmEgbW9sbGlzIGp1c3RvLCBzaXQgYW1ldCBjb25ndWUgbmliaCBtYWxlc3VhZGEgYXQuIFZpdmFtdXMgZXQgbmlzaSB2ZWwgbWFnbmEKICAgICAgICBtb2xlc3RpZSB2ZXN0aWJ1bHVtIHNvbGxpY2l0dWRpbiBhYyBudWxsYS4gUXVpc3F1ZSBlZ2V0IG1pIGVsZW1lbnR1bSBhbnRlIGVsZW1lbnR1bSBpbnRlcmR1bSBhYyBub24KICAgICAgICBzZW0uIE1hZWNlbmFzIHNlZCBlcmF0IGVnZXQgZXggaW1wZXJkaWV0IG1hdHRpcyB2aXRhZSBhdCBsaWd1bGEuIEludGVnZXIgcXVhbSB0b3J0b3IsIGxhb3JlZXQgdmVsCiAgICAgICAgdGluY2lkdW50IGFjLCBpbXBlcmRpZXQgYWMgZXJhdC4gU2VkIHNhZ2l0dGlzIGF1Z3VlIGZhY2lsaXNpcyBiaWJlbmR1bSBkYXBpYnVzLiBJbnRlZ2VyIHV0IG9ybmFyZQogICAgICAgIGRvbG9yLgogICAgICA8L3A+CiAgICA8L2Rpdj4KICA8L2ZvcmVpZ25PYmplY3Q+Cjwvc3ZnPgo=">
    <p>
        <button id="img-data-save">Save as PNG</button>
    </p>
    <script>
      (() => {
        const image = document.getElementById("img-data");
        const button = document.getElementById("img-data-save");

        button.addEventListener("click", () => {
          saveAsPng(image);
        });
      })();
    </script>
</section>

<div style="page-break-inside: avoid">
    <h2>5 cm</h2>

    <h3>&lt;svg&gt;</h3>
    <svg xmlns="http://www.w3.org/2000/svg"
         width="5cm" height="1cm">
        <line x1="0cm" y1="0.5cm" x2="5cm" y2="0.5cm" stroke="black"/>
        <line x1="0cm" y1="0cm" x2="0cm" y2="1cm" stroke="black"/>
        <line x1="1cm" y1="0cm" x2="1cm" y2="1cm" stroke="black"/>
        <line x1="2cm" y1="0cm" x2="2cm" y2="1cm" stroke="black"/>
        <line x1="3cm" y1="0cm" x2="3cm" y2="1cm" stroke="black"/>
        <line x1="4cm" y1="0cm" x2="4cm" y2="1cm" stroke="black"/>
        <line x1="5cm" y1="0cm" x2="5cm" y2="1cm" stroke="black"/>
    </svg>

    <h3>&lt;object data="image.svg"&gt;</h3>
    <object data="5cm.svg" type="image/svg+xml"></object>

    <h3>&lt;div&gt;</h3>
    <div style="
            width: 5cm;
            height: 0.5cm;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            border-top: 1px solid black;
            border-left: 1px solid black;
            border-right: 1px solid black">
        <div></div>
        <div style="border-left: 1px solid black;"></div>
        <div style="border-left: 1px solid black;"></div>
        <div style="border-left: 1px solid black;"></div>
        <div style="border-left: 1px solid black;"></div>
    </div>

    <!--
    <h2>220mm</h2>
    <p>⚠️ Chrome scales the page if it contains anything wider than @page size.</p>
    <div style="
            width: 220mm;
            height: 2mm;
            border-top: 1px solid black;
            border-left: 1px solid black;
            border-right: 1px solid black;">
    </div>
    -->

    <h2>210mm A4</h2>
    <div style="
            width: 210mm;
            height: 2mm;
            border-top: 1px solid black;
            border-left: 1px solid black;
            border-right: 1px solid black;">
    </div>

    <h2>200mm</h2>
    <div style="
            width: 200mm;
            height: 2mm;
            border-top: 1px solid black;
            border-left: 1px solid black;
            border-right: 1px solid black;">
    </div>
</div>

<footer style="margin-top: 2em;">
    <h2>References</h2>
    <ul>
        <li>
            <a href="https://stackoverflow.com/questions/3975499/convert-svg-to-image-jpeg-png-etc-in-the-browser/74026755#74026755">
                javascript - Convert SVG to image (JPEG, PNG, etc.) in the browser - Stack Overflow</a></li>
        <li><a href="https://vecta.io/blog/best-way-to-embed-svg">The Best Way to Embed SVG on HTML (2021)</a></li>
    </ul>
</footer>

</body>
</html>
